<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - Action Jackson Admin</title>

    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta name="referrer" content="strict-origin-when-cross-origin">

    <link rel="stylesheet" href="/styles/business.css">
    <link rel="stylesheet" href="/styles/admin.css">
    <script src="https://kit.fontawesome.com/8623ae8306.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="admin-layout">
        <%- include('../partials/admin-sidebar', { currentPage: 'consultations' }) %>

        <main class="admin-content">
            <div class="content-header">
                <div>
                    <h1><%= consultation.customer.name %> - Consultation #<%= consultation.requestNumber %></h1>
                    <p>Submitted on <%= consultation.createdAt.toLocaleDateString() %></p>
                </div>
                <button class="logout-btn" onclick="window.history.back()">
                    <i class="fas fa-arrow-left"></i> Back to Consultations
                </button>
            </div>

            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
                <!-- Consultation Details -->
                <div class="quotes-table">
                    <div class="table-header">
                        <h3>Consultation Details</h3>
                    </div>
                    <div style="padding: 2rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <div>
                                <h4 style="color: var(--admin-primary); margin-bottom: 1rem;">Customer Information</h4>
                                <div style="margin-bottom: 0.75rem;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 0.25rem;">Name:</label>
                                    <span><%= consultation.customer.name %></span>
                                </div>
                                <div style="margin-bottom: 0.75rem;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 0.25rem;">Email:</label>
                                    <a href="mailto:<%= consultation.customer.email %>"><%= consultation.customer.email %></a>
                                </div>
                                <% if (consultation.customer.phone) { %>
                                <div style="margin-bottom: 0.75rem;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 0.25rem;">Phone:</label>
                                    <span><%= consultation.customer.phone %></span>
                                </div>
                                <% } %>
                            </div>

                            <div>
                                <h4 style="color: var(--admin-primary); margin-bottom: 1rem;">Property Information</h4>
                                <div style="margin-bottom: 0.75rem;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 0.25rem;">Square Footage:</label>
                                    <span><%= consultation.property?.squareFootage || 'N/A' %></span>
                                </div>
                                <div style="margin-bottom: 0.75rem;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 0.25rem;">ISP:</label>
                                    <span><%= consultation.property?.isp || 'N/A' %></span>
                                </div>
                                <% if (consultation.property?.currentIssues?.length) { %>
                                <div style="margin-bottom: 0.75rem;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 0.25rem;">Current Issues:</label>
                                    <ul style="margin: 0; padding-left: 1.5rem;">
                                        <% consultation.property.currentIssues.forEach(issue => { %>
                                            <li><%= issue %></li>
                                        <% }); %>
                                    </ul>
                                </div>
                                <% } %>
                            </div>
                        </div>

                        <hr style="border-color: var(--card-border-color); margin: 1.5rem 0;">

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <div>
                                <h4 style="color: var(--admin-primary); margin-bottom: 1rem;">Service Interests</h4>
                                <div style="margin-bottom: 0.75rem;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 0.25rem;">Services:</label>
                                    <% const serviceLabels = { 'networking': 'Networking', 'smart-home': 'Smart Home', 'cameras': 'Cameras', 'structured-wiring': 'Structured Wiring' }; %>
                                    <span><%= (consultation.interestedServices || []).map(s => serviceLabels[s] || s).join(', ') %></span>
                                </div>
                                <div style="margin-bottom: 0.75rem;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 0.25rem;">Package Interest:</label>
                                    <% const pkgLabels = { 'foundation': 'Foundation Network ($799-$1,499)', 'backbone': 'Smart Home Backbone ($1,500-$3,500)', 'performance': 'Performance + Protection ($2,500-$6,000)', 'standalone': 'Standalone Services', 'unsure': 'Not Sure' }; %>
                                    <span><%= pkgLabels[consultation.interestedPackage] || consultation.interestedPackage || 'N/A' %></span>
                                </div>
                            </div>

                            <div>
                                <h4 style="color: var(--admin-primary); margin-bottom: 1rem;">Tracking</h4>
                                <div style="margin-bottom: 0.75rem;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 0.25rem;">IP Address:</label>
                                    <span style="font-family: monospace;"><%= consultation.ip || 'N/A' %></span>
                                </div>
                                <div style="margin-bottom: 0.75rem;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 0.25rem;">User Agent:</label>
                                    <span style="font-size: 0.85em; word-break: break-all;"><%= consultation.userAgent || 'N/A' %></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status & Admin Panel -->
                <div>
                    <div class="quotes-table" style="margin-bottom: 2rem;">
                        <div class="table-header">
                            <h3>Status & Actions</h3>
                        </div>
                        <div style="padding: 2rem;">
                            <form id="updateForm">
                                <div style="margin-bottom: 1.5rem;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 0.5rem;">Status:</label>
                                    <select id="statusSelect" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--card-border-color); background: var(--card-bg); color: var(--text-color);">
                                        <option value="new" <%= consultation.status === 'new' ? 'selected' : '' %>>New</option>
                                        <option value="contacted" <%= consultation.status === 'contacted' ? 'selected' : '' %>>Contacted</option>
                                        <option value="consultation-scheduled" <%= consultation.status === 'consultation-scheduled' ? 'selected' : '' %>>Consultation Scheduled</option>
                                        <option value="quoted" <%= consultation.status === 'quoted' ? 'selected' : '' %>>Quoted</option>
                                        <option value="booked" <%= consultation.status === 'booked' ? 'selected' : '' %>>Booked</option>
                                        <option value="completed" <%= consultation.status === 'completed' ? 'selected' : '' %>>Completed</option>
                                        <option value="closed" <%= consultation.status === 'closed' ? 'selected' : '' %>>Closed</option>
                                    </select>
                                </div>

                                <div style="margin-bottom: 1.5rem;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 0.5rem;">Quoted Amount:</label>
                                    <input type="number" id="quotedAmount" step="0.01" min="0"
                                           value="<%= consultation.quotedAmount || '' %>"
                                           placeholder="Enter quoted amount"
                                           style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--card-border-color); background: var(--card-bg); color: var(--text-color);">
                                </div>

                                <div style="margin-bottom: 1.5rem;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 0.5rem;">Scheduled Consultation:</label>
                                    <input type="datetime-local" id="scheduledConsultation"
                                           value="<%= consultation.scheduledConsultation ? new Date(consultation.scheduledConsultation).toISOString().slice(0, 16) : '' %>"
                                           style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--card-border-color); background: var(--card-bg); color: var(--text-color);">
                                </div>

                                <div style="margin-bottom: 1.5rem;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 0.5rem;">Admin Notes:</label>
                                    <textarea id="adminNotes" rows="5"
                                              style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--card-border-color); background: var(--card-bg); color: var(--text-color); resize: vertical;"
                                              placeholder="Internal notes..."><%= consultation.adminNotes || '' %></textarea>
                                </div>

                                <button type="submit" class="action-btn success" style="width: 100%;">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                                <div id="saveMessage" style="margin-top: 0.5rem; text-align: center;"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.getElementById('updateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msgEl = document.getElementById('saveMessage');
            msgEl.textContent = 'Saving...';
            msgEl.style.color = 'var(--text-muted)';

            try {
                const body = {
                    status: document.getElementById('statusSelect').value,
                    adminNotes: document.getElementById('adminNotes').value,
                    quotedAmount: document.getElementById('quotedAmount').value ? parseFloat(document.getElementById('quotedAmount').value) : undefined,
                    scheduledConsultation: document.getElementById('scheduledConsultation').value || undefined
                };

                const res = await fetch('/admin/consultations/<%= consultation._id %>', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (res.ok) {
                    msgEl.textContent = 'Saved successfully!';
                    msgEl.style.color = '#16a34a';
                } else {
                    const data = await res.json();
                    msgEl.textContent = data.error || 'Error saving';
                    msgEl.style.color = '#ef4444';
                }
            } catch (err) {
                msgEl.textContent = 'Network error';
                msgEl.style.color = '#ef4444';
            }
        });
    </script>
</body>
</html>
