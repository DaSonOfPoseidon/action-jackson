<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - Action Jackson Admin</title>
    
    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/styles/business.css">
    <link rel="stylesheet" href="/styles/admin.css">
    <!-- Font Awesome Kit  -->
    <script src="https://kit.fontawesome.com/8623ae8306.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="admin-layout">
        <%- include('../partials/admin-sidebar', { currentPage: 'invoices' }) %>

        <main class="admin-content">
            <div class="content-header">
                <div>
                    <h1>Invoice <%= invoice.invoiceNumber %></h1>
                    <p>Created on <%= invoice.createdAt.toLocaleDateString() %></p>
                </div>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <% if (invoice.quoteId) { %>
                        <button class="action-btn secondary view-quote-btn" data-quote-id="<%= invoice.quoteId._id || invoice.quoteId %>">
                            <i class="fas fa-file-alt"></i> View Original Quote
                        </button>
                    <% } %>
                    <button class="logout-btn" onclick="window.history.back()">
                        <i class="fas fa-arrow-left"></i> Back to Invoices
                    </button>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
                <!-- Invoice Details -->
                <div class="quotes-table">
                    <div class="table-header">
                        <h3>Invoice Information</h3>
                    </div>
                    <div style="padding: 2rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <div>
                                <h4 style="color: var(--admin-primary); margin-bottom: 1rem;">Customer Information</h4>
                                
                                <!-- Customer Name -->
                                <div style="margin-bottom: 1rem;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 0.25rem;">Name:</label>
                                    <span style="color: var(--text-color);"><%= invoice.customer.name %></span>
                                </div>
                                
                                <!-- Customer Email -->
                                <div style="margin-bottom: 1rem;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 0.25rem;">Email:</label>
                                    <span style="color: var(--text-color);"><%= invoice.customer.email %></span>
                                </div>
                                
                                <!-- Package Option -->
                                <div style="margin-bottom: 1rem;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 0.25rem;">Package:</label>
                                    <span style="color: var(--text-color);"><%= invoice.packageOption %></span>
                                </div>
                                
                                <!-- Service Description -->
                                <div style="margin-bottom: 1rem;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 0.25rem;">Service Description:</label>
                                    <span style="color: var(--text-color);"><%= invoice.serviceDescription %></span>
                                </div>
                            </div>
                            
                            <div>
                                <h4 style="color: var(--admin-primary); margin-bottom: 1rem;">Invoice Details</h4>
                                
                                <!-- Invoice Number -->
                                <div style="margin-bottom: 1rem;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 0.25rem;">Invoice Number:</label>
                                    <span style="color: var(--admin-primary); font-family: 'Courier New', monospace; font-weight: 600;"><%= invoice.invoiceNumber %></span>
                                </div>
                                
                                <!-- Issue Date -->
                                <div style="margin-bottom: 1rem;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 0.25rem;">Issue Date:</label>
                                    <span style="color: var(--text-color);"><%= invoice.issueDate.toLocaleDateString() %></span>
                                </div>
                                
                                <!-- Due Date -->
                                <div style="margin-bottom: 1rem;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 0.25rem;">Due Date:</label>
                                    <span style="color: var(--text-color);"><%= invoice.dueDate ? invoice.dueDate.toLocaleDateString() : 'Not set' %></span>
                                </div>
                                
                                <!-- Paid Date -->
                                <% if (invoice.paidDate) { %>
                                <div style="margin-bottom: 1rem;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 0.25rem;">Paid Date:</label>
                                    <span style="color: var(--admin-success);"><%= invoice.paidDate.toLocaleDateString() %></span>
                                </div>
                                <% } %>
                            </div>
                        </div>

                        <!-- Pricing Information -->
                        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--card-border-color);">
                            <h4 style="color: var(--admin-primary); margin-bottom: 1rem;">Pricing Information</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                                <div>
                                    <div style="margin-bottom: 0.5rem;">
                                        <label style="font-weight: bold; display: inline-block; width: 120px;">Amount:</label>
                                        <span style="color: var(--text-color);">$<%= invoice.amount.toFixed(2) %></span>
                                    </div>
                                    <% if (invoice.discount > 0) { %>
                                    <div style="margin-bottom: 0.5rem;">
                                        <label style="font-weight: bold; display: inline-block; width: 120px;">Discount:</label>
                                        <span style="color: var(--admin-warning);"><%= invoice.discount %>%</span>
                                    </div>
                                    <% } %>
                                    <div style="margin-bottom: 0.5rem;">
                                        <label style="font-weight: bold; display: inline-block; width: 120px;">Final Amount:</label>
                                        <span style="color: var(--admin-success); font-weight: 600; font-size: 1.1em;">$<%= invoice.finalAmount.toFixed(2) %></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Service Details (if available from quote) -->
                        <% if (invoice.quoteId && (invoice.runs || invoice.services)) { %>
                        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--card-border-color);">
                            <h4 style="color: var(--admin-primary); margin-bottom: 1rem;">Service Details</h4>
                            
                            <% if (invoice.runs && (invoice.runs.coax > 0 || invoice.runs.cat6 > 0)) { %>
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin-bottom: 0.5rem; font-weight: 600;">Cable Runs:</h5>
                                <% if (invoice.runs.coax > 0) { %>
                                <div style="margin-bottom: 0.25rem;">
                                    <span style="font-weight: bold;">Coax:</span> <%= invoice.runs.coax %> runs
                                </div>
                                <% } %>
                                <% if (invoice.runs.cat6 > 0) { %>
                                <div style="margin-bottom: 0.25rem;">
                                    <span style="font-weight: bold;">Cat6:</span> <%= invoice.runs.cat6 %> runs
                                </div>
                                <% } %>
                            </div>
                            <% } %>
                            
                            <% if (invoice.services && (invoice.services.deviceMount > 0 || invoice.services.networkSetup > 0 || invoice.services.mediaPanel > 0)) { %>
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin-bottom: 0.5rem; font-weight: 600;">Additional Services:</h5>
                                <% if (invoice.services.deviceMount > 0) { %>
                                <div style="margin-bottom: 0.25rem;">
                                    <span style="font-weight: bold;">Device Mounting:</span> <%= invoice.services.deviceMount %>
                                </div>
                                <% } %>
                                <% if (invoice.services.networkSetup > 0) { %>
                                <div style="margin-bottom: 0.25rem;">
                                    <span style="font-weight: bold;">Network Setup:</span> <%= invoice.services.networkSetup %>
                                </div>
                                <% } %>
                                <% if (invoice.services.mediaPanel > 0) { %>
                                <div style="margin-bottom: 0.25rem;">
                                    <span style="font-weight: bold;">Media Panel:</span> <%= invoice.services.mediaPanel %>
                                </div>
                                <% } %>
                            </div>
                            <% } %>
                        </div>
                        <% } %>

                        <!-- Equipment List (if available) -->
                        <% if (invoice.equipment && invoice.equipment.length > 0) { %>
                        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--card-border-color);">
                            <h4 style="color: var(--admin-primary); margin-bottom: 1rem;">Equipment</h4>
                            <div class="table-responsive">
                                <table style="width: 100%;">
                                    <thead>
                                        <tr style="background: var(--surface-light);">
                                            <th>Item</th>
                                            <th>SKU</th>
                                            <th>Quantity</th>
                                            <th>Unit Price</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% invoice.equipment.forEach(item => { %>
                                        <tr>
                                            <td><%= item.name %></td>
                                            <td><%= item.sku %></td>
                                            <td><%= item.quantity %></td>
                                            <td>$<%= item.price.toFixed(2) %></td>
                                            <td>$<%= (item.price * item.quantity).toFixed(2) %></td>
                                        </tr>
                                        <% }) %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <% } %>
                    </div>
                </div>

                <!-- Status & Actions Sidebar -->
                <div>
                    <!-- Status Card -->
                    <div class="quotes-table" style="margin-bottom: 2rem;">
                        <div class="table-header">
                            <h3>Status & Actions</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="margin-bottom: 1.5rem;">
                                <span class="status-badge status-<%= invoice.status.toLowerCase() %>">
                                    <% if (invoice.status.toLowerCase() === 'draft') { %>
                                        <i class="fas fa-edit"></i>
                                    <% } else if (invoice.status.toLowerCase() === 'sent') { %>
                                        <i class="fas fa-paper-plane"></i>
                                    <% } else if (invoice.status.toLowerCase() === 'paid') { %>
                                        <i class="fas fa-check-circle"></i>
                                    <% } else if (invoice.status.toLowerCase() === 'overdue') { %>
                                        <i class="fas fa-exclamation-triangle"></i>
                                    <% } else if (invoice.status.toLowerCase() === 'cancelled') { %>
                                        <i class="fas fa-times-circle"></i>
                                    <% } %>
                                    <%= invoice.status.toUpperCase() %>
                                </span>
                            </div>

                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <% if (invoice.status.toLowerCase() === 'draft') { %>
                                <button class="action-btn success update-status-btn" data-invoice-id="<%= invoice._id %>" data-status="sent">
                                    <i class="fas fa-paper-plane"></i> Send Invoice
                                </button>
                                <% } %>
                                <% if (invoice.status.toLowerCase() === 'sent') { %>
                                <button class="action-btn success update-status-btn" data-invoice-id="<%= invoice._id %>" data-status="paid">
                                    <i class="fas fa-check"></i> Mark as Paid
                                </button>
                                <button class="action-btn warning update-status-btn" data-invoice-id="<%= invoice._id %>" data-status="overdue">
                                    <i class="fas fa-exclamation-triangle"></i> Mark Overdue
                                </button>
                                <% } %>
                                <% if (invoice.status.toLowerCase() !== 'cancelled' && invoice.status.toLowerCase() !== 'paid') { %>
                                <button class="action-btn danger update-status-btn" data-invoice-id="<%= invoice._id %>" data-status="cancelled">
                                    <i class="fas fa-times"></i> Cancel Invoice
                                </button>
                                <% } %>
                                <% if (user.role === 'superadmin') { %>
                                <button class="action-btn danger delete-invoice-btn" data-invoice-id="<%= invoice._id %>">
                                    <i class="fas fa-trash"></i> Delete Invoice
                                </button>
                                <% } %>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Summary -->
                    <div class="quotes-table">
                        <div class="table-header">
                            <h3>Financial Summary</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Amount:</span>
                                <span>$<%= invoice.amount.toFixed(2) %></span>
                            </div>
                            <% if (invoice.discount > 0) { %>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; color: var(--admin-warning);">
                                <span>Discount (<%= invoice.discount %>%):</span>
                                <span>-$<%= (invoice.amount * invoice.discount / 100).toFixed(2) %></span>
                            </div>
                            <% } %>
                            <hr style="border: none; border-top: 1px solid var(--card-border-color); margin: 1rem 0;">
                            <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1em;">
                                <span>Final Amount:</span>
                                <span class="amount">$<%= invoice.finalAmount.toFixed(2) %></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Add event listeners when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Update status buttons
            document.querySelectorAll('.update-status-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const invoiceId = this.getAttribute('data-invoice-id');
                    const status = this.getAttribute('data-status');
                    updateInvoiceStatus(invoiceId, status);
                });
            });
            
            // Delete invoice buttons
            document.querySelectorAll('.delete-invoice-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const invoiceId = this.getAttribute('data-invoice-id');
                    deleteInvoice(invoiceId);
                });
            });
            
            // View quote buttons
            document.querySelectorAll('.view-quote-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const quoteId = this.getAttribute('data-quote-id');
                    window.location.href = `/admin/quotes/${quoteId}`;
                });
            });
        });

        async function updateInvoiceStatus(id, status) {
            const statusLabels = {
                'sent': 'sent',
                'paid': 'paid',
                'overdue': 'overdue',
                'cancelled': 'cancelled'
            };
            
            if (!confirm(`Are you sure you want to mark this invoice as ${statusLabels[status] || status}?`)) {
                return;
            }

            try {
                const response = await fetch(`/admin/invoices/${id}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ status })
                });

                const data = await response.json();

                if (data.success) {
                    location.reload();
                } else {
                    alert('Failed to update status: ' + data.error);
                }
            } catch (error) {
                console.error('Status update error:', error);
                alert('Error updating status. Please try again.');
            }
        }

        async function deleteInvoice(id) {
            if (!confirm('Are you sure you want to delete this invoice? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/admin/invoices/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.success) {
                    alert('Invoice deleted successfully');
                    window.location.href = '/admin/invoices';
                } else {
                    alert('Failed to delete invoice: ' + data.error);
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Error deleting invoice. Please try again.');
            }
        }
    </script>
</body>
</html>