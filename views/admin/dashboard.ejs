<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - Action Jackson Admin</title>
    
    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/styles/business.css">
    <link rel="stylesheet" href="/styles/admin.css">
    <!-- Font Awesome Kit  -->
    <script src="https://kit.fontawesome.com/8623ae8306.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="admin-layout">
        <%- include('../partials/admin-sidebar', { currentPage: 'dashboard' }) %>

        <main class="admin-content">
            <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>

            <div class="content-header">
                <h1>Dashboard</h1>
                <p>Overview of your Action Jackson business operations</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-file-invoice"></i>
                    </div>
                    <div class="stat-number"><%= stats.quotes %></div>
                    <div class="stat-label">New Quotes (30 days)</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="stat-number"><%= stats.schedules %></div>
                    <div class="stat-label">New Appointments (30 days)</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <div class="stat-number"><%= stats.invoices %></div>
                    <div class="stat-label">New Invoices (30 days)</div>
                </div>
            </div>

            <div class="activity-grid">
                <div class="activity-card">
                    <div class="activity-header">
                        <h3>Recent Quotes</h3>
                    </div>
                    <div class="activity-list">
                        <% if (recentActivity.quotes.length > 0) { %>
                            <% recentActivity.quotes.forEach(quote => { %>
                                <div class="activity-item">
                                    <div class="activity-info">
                                        <h4><%= quote.customerName %></h4>
                                        <p><%= quote.serviceType %> - $<%= quote.totalCost %></p>
                                    </div>
                                    <div class="activity-meta">
                                        <div><%= quote.createdAt.toLocaleDateString() %></div>
                                        <div class="status-badge status-<%= quote.status || 'pending' %>">
                                            <%= (quote.status || 'pending').toUpperCase() %>
                                        </div>
                                    </div>
                                </div>
                            <% }) %>
                        <% } else { %>
                            <div class="activity-item">
                                <div class="activity-info">
                                    <p>No recent quotes</p>
                                </div>
                            </div>
                        <% } %>
                    </div>
                </div>

                <div class="activity-card">
                    <div class="activity-header">
                        <h3>Recent Appointments</h3>
                    </div>
                    <div class="activity-list">
                        <% if (recentActivity.schedules.length > 0) { %>
                            <% recentActivity.schedules.forEach(schedule => { %>
                                <div class="activity-item">
                                    <div class="activity-info">
                                        <h4><%= schedule.customerName %></h4>
                                        <p><%= schedule.service %></p>
                                    </div>
                                    <div class="activity-meta">
                                        <div><%= schedule.scheduledDate.toLocaleDateString() %></div>
                                        <div class="status-badge status-<%= schedule.status || 'pending' %>">
                                            <%= (schedule.status || 'pending').toUpperCase() %>
                                        </div>
                                    </div>
                                </div>
                            <% }) %>
                        <% } else { %>
                            <div class="activity-item">
                                <div class="activity-info">
                                    <p>No recent appointments</p>
                                </div>
                            </div>
                        <% } %>
                    </div>
                </div>

                <div class="activity-card">
                    <div class="activity-header">
                        <h3>Recent Invoices</h3>
                    </div>
                    <div class="activity-list">
                        <% if (recentActivity.invoices.length > 0) { %>
                            <% recentActivity.invoices.forEach(invoice => { %>
                                <div class="activity-item">
                                    <div class="activity-info">
                                        <h4><%= invoice.customer.name %></h4>
                                        <p><%= invoice.invoiceNumber %> - $<%= invoice.finalAmount %></p>
                                    </div>
                                    <div class="activity-meta">
                                        <div><%= invoice.createdAt.toLocaleDateString() %></div>
                                        <div class="status-badge status-<%= invoice.status || 'pending' %>">
                                            <%= (invoice.status || 'pending').toUpperCase() %>
                                        </div>
                                    </div>
                                </div>
                            <% }) %>
                        <% } else { %>
                            <div class="activity-item">
                                <div class="activity-info">
                                    <p>No recent invoices</p>
                                </div>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Add event listener when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('logoutBtn').addEventListener('click', logout);
        });

        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    console.log('Making logout request...');
                    const response = await fetch('/auth/logout', {
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    console.log('Logout response:', response.status, response.ok);
                    const data = await response.json();
                    console.log('Logout data:', data);

                    if (response.ok) {
                        console.log('Logout successful, redirecting...');
                        window.location.href = '/';
                    } else {
                        console.error('Logout failed:', data);
                        alert('Logout failed: ' + (data.error || 'Please try again.'));
                    }
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('Logout error: ' + error.message);
                }
            }
        }

        // Auto-refresh dashboard every 5 minutes
        setInterval(() => {
            window.location.reload();
        }, 5 * 60 * 1000);
    </script>
</body>
</html>