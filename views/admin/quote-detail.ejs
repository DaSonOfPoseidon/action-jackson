<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - Action Jackson Admin</title>

    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta name="referrer" content="strict-origin-when-cross-origin">

    <!-- CSS -->
    <link rel="stylesheet" href="/styles/business.css">
    <link rel="stylesheet" href="/styles/admin.css">
    <!-- Font Awesome Kit  -->
    <script src="https://kit.fontawesome.com/8623ae8306.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="admin-layout">
        <%- include('../partials/admin-sidebar', { currentPage: 'quotes' }) %>

        <main class="admin-content">
            <div class="content-header">
                <div>
                    <h1><%= quote.customer.name %> - Quote Details</h1>
                    <p>Quote submitted on <%= quote.createdAt.toLocaleDateString() %></p>
                </div>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <% if (quote.status === 'approved' && !quote.invoiceId) { %>
                        <button class="action-btn success convert-to-invoice-btn" data-quote-id="<%= quote._id %>">
                            <i class="fas fa-file-invoice"></i> Create Invoice
                        </button>
                    <% } else if (quote.invoiceId) { %>
                        <button class="action-btn secondary view-invoice-btn" data-invoice-id="<%= quote.invoiceId %>">
                            <i class="fas fa-external-link-alt"></i> View Invoice
                        </button>
                    <% } %>
                    <button class="logout-btn" onclick="window.history.back()">
                        <i class="fas fa-arrow-left"></i> Back to Quotes
                    </button>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
                <!-- Quote Details -->
                <div class="quotes-table">
                    <div class="table-header">
                        <h3>Quote Information</h3>
                    </div>
                    <div style="padding: 2rem;">
                        <!-- Edit Mode Toggle -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--card-border-color);">
                            <h4 style="color: var(--admin-primary); margin: 0;">Quote Details</h4>
                            <button id="editToggle" class="action-btn">
                                <i class="fas fa-edit"></i> <span id="editToggleText">Edit Quote</span>
                            </button>
                        </div>

                        <form id="quoteEditForm" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <div>
                                <h4 style="color: var(--admin-primary); margin-bottom: 1rem;">Customer Information</h4>

                                <div style="margin-bottom: 1rem;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 0.25rem;">Name:</label>
                                    <input type="text" id="customerName" value="<%= quote.customer.name %>" readonly
                                           style="border: none; background: transparent; color: var(--text-color); font-size: inherit;">
                                </div>

                                <div style="margin-bottom: 1rem;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 0.25rem;">Email:</label>
                                    <input type="email" id="customerEmail" value="<%= quote.customer.email %>" readonly
                                           style="border: none; background: transparent; color: var(--text-color); font-size: inherit;">
                                </div>

                                <% if (quote.customer.phone) { %>
                                <div style="margin-bottom: 1rem;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 0.25rem;">Phone:</label>
                                    <span style="color: var(--text-color);"><%= quote.customer.phone %></span>
                                </div>
                                <% } %>

                                <!-- Service Type -->
                                <div style="margin-bottom: 1rem;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 0.25rem;">Service Type:</label>
                                    <span style="color: var(--text-color); font-size: 1.1em; font-weight: 500;">
                                        <%= quote.serviceType || (quote.packageOption ? quote.packageOption + ' (Legacy)' : 'Unknown') %>
                                    </span>
                                </div>

                                <!-- Discount -->
                                <div style="margin-bottom: 1rem;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 0.25rem;">Discount (%):</label>
                                    <input type="number" id="discount" name="discount" min="0" max="100" step="1"
                                           value="<%= quote.discount || 0 %>" readonly class="readonly-field"
                                           style="border: none; background: transparent; color: var(--text-color); font-size: inherit; width: 80px;">
                                </div>
                            </div>

                            <div>
                                <% if (quote.serviceType === 'Drops Only' || quote.packageOption) { %>
                                <h4 style="color: var(--admin-primary); margin-bottom: 1rem;">Cable Runs & Services</h4>

                                <div style="margin-bottom: 1.5rem;">
                                    <h5 style="margin-bottom: 0.5rem; font-weight: 600;">Cable Runs:</h5>
                                    <div style="margin-bottom: 0.5rem;">
                                        <label style="font-weight: bold; display: inline-block; width: 60px;">Coax:</label>
                                        <input type="number" id="coaxRuns" name="runs.coax" min="0"
                                               value="<%= quote.runs ? quote.runs.coax || 0 : 0 %>" readonly class="readonly-field"
                                               style="border: none; background: transparent; color: var(--text-color); font-size: inherit; width: 60px;">
                                        runs
                                    </div>
                                    <div style="margin-bottom: 0.5rem;">
                                        <label style="font-weight: bold; display: inline-block; width: 60px;">Cat6:</label>
                                        <input type="number" id="cat6Runs" name="runs.cat6" min="0"
                                               value="<%= quote.runs ? quote.runs.cat6 || 0 : 0 %>" readonly class="readonly-field"
                                               style="border: none; background: transparent; color: var(--text-color); font-size: inherit; width: 60px;">
                                        runs
                                    </div>
                                    <div style="margin-bottom: 0.5rem;">
                                        <label style="font-weight: bold; display: inline-block; width: 60px;">Fiber:</label>
                                        <input type="number" id="fiberRuns" name="runs.fiber" min="0"
                                               value="<%= quote.runs ? quote.runs.fiber || 0 : 0 %>" readonly class="readonly-field"
                                               style="border: none; background: transparent; color: var(--text-color); font-size: inherit; width: 60px;">
                                        runs
                                    </div>
                                </div>

                                <% if (quote.centralization) { %>
                                <div style="margin-bottom: 1.5rem;">
                                    <h5 style="margin-bottom: 0.5rem; font-weight: 600;">Drop Centralization:</h5>
                                    <div style="margin-bottom: 0.5rem;">
                                        <label style="font-weight: bold; display: inline-block; width: 150px;">Method:</label>
                                        <span style="color: var(--text-color);">
                                            <%= quote.centralization %>
                                            <% if (quote.centralization === 'Media Panel') { %>
                                                (<%= quote.homeInfo && quote.homeInfo.hasMediaPanel ? 'Existing - $0' : 'New Install - $100' %>)
                                            <% } else if (quote.centralization === 'Patch Panel') { %>
                                                ($50)
                                            <% } else { %>
                                                (Free)
                                            <% } %>
                                        </span>
                                    </div>
                                </div>
                                <% } %>

                                <div style="margin-bottom: 1.5rem;">
                                    <h5 style="margin-bottom: 0.5rem; font-weight: 600;">Add-on Services:</h5>
                                    <% if (!quote.centralization && quote.services && quote.services.mediaPanel > 0) { %>
                                    <div style="margin-bottom: 0.5rem;">
                                        <label style="font-weight: bold; display: inline-block; width: 150px;">Media Panel <span style="font-size: 0.75em; color: var(--text-muted);">(Legacy)</span>:</label>
                                        <input type="number" id="mediaPanel" name="services.mediaPanel" min="0"
                                               value="<%= quote.services.mediaPanel %>" readonly class="readonly-field"
                                               style="border: none; background: transparent; color: var(--text-color); font-size: inherit; width: 60px;">
                                    </div>
                                    <% } %>
                                    <div style="margin-bottom: 0.5rem;">
                                        <label style="font-weight: bold; display: inline-block; width: 150px;">AP Mounting:</label>
                                        <input type="number" id="apMount" name="services.apMount" min="0"
                                               value="<%= quote.services ? quote.services.apMount || 0 : 0 %>" readonly class="readonly-field"
                                               style="border: none; background: transparent; color: var(--text-color); font-size: inherit; width: 60px;">
                                    </div>
                                    <div style="margin-bottom: 0.5rem;">
                                        <label style="font-weight: bold; display: inline-block; width: 150px;">Eth Relocation:</label>
                                        <input type="number" id="ethRelocation" name="services.ethRelocation" min="0"
                                               value="<%= quote.services ? quote.services.ethRelocation || 0 : 0 %>" readonly class="readonly-field"
                                               style="border: none; background: transparent; color: var(--text-color); font-size: inherit; width: 60px;">
                                    </div>
                                </div>

                                <div style="margin-bottom: 1.5rem;">
                                    <h5 style="margin-bottom: 0.5rem; font-weight: 600;">Pricing:</h5>
                                    <div style="margin-bottom: 0.5rem;">
                                        <label style="font-weight: bold; display: inline-block; width: 120px;">Total Cost:</label>
                                        $<span id="totalCost" style="color: var(--admin-success); font-weight: 600; font-size: 1.1em;">
                                            <%= quote.pricing ? quote.pricing.totalCost || 0 : 0 %>
                                        </span>
                                    </div>
                                    <div style="margin-bottom: 0.5rem;">
                                        <label style="font-weight: bold; display: inline-block; width: 120px;">Deposit:</label>
                                        $<span id="depositRequired" style="color: var(--admin-warning); font-weight: 600; font-size: 1.1em;">
                                            <%= quote.pricing ? quote.pricing.depositRequired || 0 : 0 %>
                                        </span>
                                    </div>
                                </div>
                                <% } %>

                                <% if (quote.serviceType === 'Whole-Home' && quote.wholeHome) { %>
                                <h4 style="color: var(--admin-primary); margin-bottom: 1rem;">Whole-Home Details</h4>

                                <div style="margin-bottom: 1rem;">
                                    <h5 style="margin-bottom: 0.5rem; font-weight: 600;">Scope:</h5>
                                    <% if (quote.wholeHome.scope) { %>
                                        <% if (quote.wholeHome.scope.networking) { %><span class="status-badge status-approved" style="margin-right: 0.5rem;">Networking</span><% } %>
                                        <% if (quote.wholeHome.scope.security) { %><span class="status-badge status-approved" style="margin-right: 0.5rem;">Security</span><% } %>
                                        <% if (quote.wholeHome.scope.voip) { %><span class="status-badge status-approved" style="margin-right: 0.5rem;">VoIP</span><% } %>
                                    <% } %>
                                </div>

                                <% if (quote.wholeHome.internetSpeed) { %>
                                <div style="margin-bottom: 0.5rem;">
                                    <label style="font-weight: bold;">Internet Speed:</label>
                                    <span><%= quote.wholeHome.internetSpeed %></span>
                                </div>
                                <% } %>

                                <div style="margin-bottom: 0.5rem;">
                                    <label style="font-weight: bold;">Own Equipment:</label>
                                    <span><%= quote.wholeHome.hasOwnEquipment ? 'Yes' : 'No' %></span>
                                </div>

                                <% if (quote.wholeHome.hasOwnEquipment && quote.wholeHome.equipmentDescription) { %>
                                <div style="margin-bottom: 0.5rem;">
                                    <label style="font-weight: bold;">Equipment Description:</label>
                                    <p style="white-space: pre-wrap; background: var(--surface-light); padding: 0.75rem; border-radius: var(--radius);"><%= quote.wholeHome.equipmentDescription %></p>
                                </div>
                                <% } %>

                                <% if (!quote.wholeHome.hasOwnEquipment) { %>
                                    <% if (quote.wholeHome.networkingBrand) { %>
                                    <div style="margin-bottom: 0.5rem;">
                                        <label style="font-weight: bold;">Networking Brand:</label>
                                        <span><%= quote.wholeHome.networkingBrand %></span>
                                    </div>
                                    <% } %>
                                    <% if (quote.wholeHome.securityBrand) { %>
                                    <div style="margin-bottom: 0.5rem;">
                                        <label style="font-weight: bold;">Security Brand:</label>
                                        <span><%= quote.wholeHome.securityBrand %></span>
                                    </div>
                                    <% } %>
                                <% } %>

                                <% if (quote.wholeHome.surveyPreference) { %>
                                <div style="margin-bottom: 0.5rem;">
                                    <label style="font-weight: bold;">Survey Preference:</label>
                                    <span><%= quote.wholeHome.surveyPreference === 'before-install' ? 'Before install' : 'Day of install' %></span>
                                </div>
                                <% } %>

                                <% if (quote.wholeHome.notes) { %>
                                <div style="margin-bottom: 0.5rem;">
                                    <label style="font-weight: bold;">Notes:</label>
                                    <p style="white-space: pre-wrap; background: var(--surface-light); padding: 0.75rem; border-radius: var(--radius);"><%= quote.wholeHome.notes %></p>
                                </div>
                                <% } %>

                                <div style="margin-top: 1rem;">
                                    <h5 style="margin-bottom: 0.5rem; font-weight: 600;">Final Quote Amount:</h5>
                                    <div style="margin-bottom: 0.5rem;">
                                        <label style="font-weight: bold;">Deposit:</label>
                                        <span style="color: var(--admin-warning); font-weight: 600;">$<%= quote.pricing ? quote.pricing.depositAmount || 200 : 200 %></span>
                                    </div>
                                    <div style="margin-bottom: 0.5rem;">
                                        <label style="font-weight: bold;">Admin Final Quote $:</label>
                                        <input type="number" id="finalQuoteAmount" name="finalQuoteAmount" step="0.01" min="0"
                                               value="<%= quote.finalQuoteAmount || '' %>" readonly class="readonly-field"
                                               placeholder="Set after survey"
                                               style="border: none; background: transparent; color: var(--admin-success); font-size: 1.1em; font-weight: 600; width: 120px;">
                                    </div>
                                </div>
                                <% } %>
                            </div>
                        </form>

                        <% if (quote.homeInfo) { %>
                        <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--card-border-color);">
                            <h4 style="color: var(--admin-primary); margin-bottom: 1rem;">Home Information</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <div style="margin-bottom: 0.5rem;"><strong>Home Age:</strong> <%= quote.homeInfo.homeAge || 'N/A' %></div>
                                    <div style="margin-bottom: 0.5rem;"><strong>Stories:</strong> <%= quote.homeInfo.stories || 'N/A' %></div>
                                    <div style="margin-bottom: 0.5rem;"><strong>Attic Access:</strong> <%= quote.homeInfo.atticAccess || 'N/A' %></div>
                                </div>
                                <div>
                                    <div style="margin-bottom: 0.5rem;"><strong>Media Panel:</strong> <%= quote.homeInfo.hasMediaPanel ? 'Yes' + (quote.homeInfo.mediaPanelLocation ? ' (' + quote.homeInfo.mediaPanelLocation + ')' : '') : 'No' %></div>
                                    <div style="margin-bottom: 0.5rem;"><strong>Crawl Space/Basement:</strong> <%= quote.homeInfo.hasCrawlspaceOrBasement ? 'Yes' : 'No' %></div>
                                    <div style="margin-bottom: 0.5rem;"><strong>Liability Acknowledged:</strong> <%= quote.homeInfo.liabilityAcknowledged ? 'Yes' : 'No' %></div>
                                </div>
                            </div>
                        </div>
                        <% } %>

                        <!-- Save/Cancel Buttons (hidden by default) -->
                        <div id="editActions" style="display: none; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--card-border-color); text-align: right;">
                            <button id="cancelEdit" class="action-btn" style="margin-right: 1rem;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <button id="saveQuote" class="action-btn success">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </div>

                        <!-- Admin Notes Section -->
                        <div style="margin-top: 2rem;">
                            <h4 style="color: var(--admin-primary); margin-bottom: 1rem;">Admin Notes</h4>
                            <textarea id="adminNotes" name="adminNotes" readonly class="readonly-field"
                                      style="width: 100%; min-height: 100px; border: none; background: var(--surface-light); padding: 1rem; border-radius: var(--radius); color: var(--text-color); font-family: inherit; resize: vertical;"
                                      placeholder="Add internal notes about this quote..."><%= quote.adminNotes || '' %></textarea>
                        </div>
                    </div>
                </div>

                <!-- Status & Pricing Sidebar -->
                <div>
                    <!-- Status Card -->
                    <div class="quotes-table" style="margin-bottom: 2rem;">
                        <div class="table-header">
                            <h3>Status & Actions</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="margin-bottom: 1.5rem;">
                                <span class="status-badge status-<%= quote.status || 'pending' %>">
                                    <%= (quote.status || 'pending').toUpperCase() %>
                                </span>
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <% if (quote.invoiceId) { %>
                                    <span class="invoice-badge invoice-created">
                                        <i class="fas fa-file-invoice"></i> Invoice Created
                                    </span>
                                <% } else if (quote.status === 'approved') { %>
                                    <span class="invoice-badge invoice-ready">
                                        <i class="fas fa-clock"></i> Ready for Invoice
                                    </span>
                                <% } else { %>
                                    <span class="invoice-badge invoice-pending">
                                        <i class="fas fa-minus"></i> Invoice N/A
                                    </span>
                                <% } %>
                            </div>

                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <% if (quote.status !== 'approved') { %>
                                <button class="action-btn success update-status-btn" data-quote-id="<%= quote._id %>" data-status="approved">
                                    <i class="fas fa-check"></i> Approve Quote
                                </button>
                                <% } %>
                                <button class="action-btn update-status-btn" data-quote-id="<%= quote._id %>" data-status="reviewed">
                                    <i class="fas fa-eye"></i> Mark Reviewed
                                </button>
                                <button class="action-btn danger update-status-btn" data-quote-id="<%= quote._id %>" data-status="rejected">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                            </div>

                            <% if (quote.updatedBy) { %>
                            <div style="margin-top: 1rem; font-size: 0.75rem; color: var(--text-muted);">
                                Last updated by <%= quote.updatedBy %>
                            </div>
                            <% } %>
                        </div>
                    </div>

                    <!-- Pricing Card -->
                    <div class="quotes-table">
                        <div class="table-header">
                            <h3>Pricing Details</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <% if (quote.serviceType === 'Whole-Home') { %>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span>Deposit:</span>
                                    <span class="amount">$<%= quote.pricing.depositAmount || 200 %></span>
                                </div>
                                <% if (quote.finalQuoteAmount) { %>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span>Final Quote:</span>
                                    <span class="amount">$<%= quote.finalQuoteAmount %></span>
                                </div>
                                <% } else { %>
                                <div style="font-style: italic; color: var(--text-muted); font-size: 0.9rem;">
                                    Final pricing pending site survey
                                </div>
                                <% } %>
                            <% } else { %>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span>Total Cost:</span>
                                    <span class="amount">$<%= quote.pricing.totalCost || 0 %></span>
                                </div>
                                <% if (quote.pricing.depositRequired) { %>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span>Deposit Required:</span>
                                    <span>$<%= quote.pricing.depositRequired %></span>
                                </div>
                                <% } %>
                            <% } %>

                            <% if (quote.discount > 0) { %>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; color: var(--admin-success);">
                                <span>Discount:</span>
                                <span>-<%= quote.discount %>%</span>
                            </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Quote to Invoice Conversion Modal -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Convert Quote to Invoice</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body" id="invoiceModalBody">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> Loading quote details...
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            setupPricingCalculation();

            const editToggle = document.getElementById('editToggle');
            if (editToggle) {
                editToggle.addEventListener('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    toggleEditMode();
                });
            }

            const cancelEditBtn = document.getElementById('cancelEdit');
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', function() { cancelEdit(); });
            }

            const saveQuoteBtn = document.getElementById('saveQuote');
            if (saveQuoteBtn) {
                saveQuoteBtn.addEventListener('click', function() { saveQuote(); });
            }

            document.querySelectorAll('.update-status-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    updateStatus(this.getAttribute('data-quote-id'), this.getAttribute('data-status'));
                });
            });

            document.querySelectorAll('.convert-to-invoice-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    openInvoiceModal(this.getAttribute('data-quote-id'));
                });
            });

            document.querySelectorAll('.view-invoice-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    window.location.href = '/admin/invoices/' + this.getAttribute('data-invoice-id');
                });
            });

            const closeBtn = document.querySelector('.close');
            if (closeBtn) {
                closeBtn.addEventListener('click', function() { closeInvoiceModal(); });
            }

            window.addEventListener('click', function(event) {
                if (event.target === document.getElementById('invoiceModal')) {
                    closeInvoiceModal();
                }
            });
        });

        async function updateStatus(id, status) {
            if (!confirm('Are you sure you want to mark this quote as ' + status + '?')) return;
            try {
                const response = await fetch('/admin/quotes/' + id + '/status', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ status })
                });
                const data = await response.json();
                if (data.success) { location.reload(); }
                else { alert('Failed to update status: ' + data.error); }
            } catch (error) {
                console.error('Status update error:', error);
                alert('Error updating status.');
            }
        }

        async function openInvoiceModal(quoteId) {
            const modal = document.getElementById('invoiceModal');
            const modalBody = document.getElementById('invoiceModalBody');
            modal.style.display = 'block';
            modalBody.textContent = 'Loading quote details...';
            try {
                const response = await fetch('/admin/quotes/<%= quote._id %>/data', { credentials: 'include' });
                if (!response.ok) throw new Error('Failed to fetch');
                const quote = await response.json();
                renderInvoiceForm(quote);
            } catch (error) {
                modalBody.textContent = 'Error loading quote details.';
            }
        }

        function closeInvoiceModal() {
            document.getElementById('invoiceModal').style.display = 'none';
        }

        function renderInvoiceForm(quote) {
            const modalBody = document.getElementById('invoiceModalBody');
            while (modalBody.firstChild) modalBody.removeChild(modalBody.firstChild);

            const wrapper = document.createElement('div');
            wrapper.className = 'invoice-form';

            const summary = document.createElement('div');
            summary.className = 'quote-summary';
            const h3 = document.createElement('h3');
            h3.textContent = 'Quote Summary';
            summary.appendChild(h3);

            const custP = document.createElement('p');
            const custStrong = document.createElement('strong');
            custStrong.textContent = 'Customer: ';
            custP.appendChild(custStrong);
            custP.appendChild(document.createTextNode(quote.customer.name + ' (' + quote.customer.email + ')'));
            summary.appendChild(custP);

            const svcP = document.createElement('p');
            const svcStrong = document.createElement('strong');
            svcStrong.textContent = 'Service: ';
            svcP.appendChild(svcStrong);
            svcP.appendChild(document.createTextNode(quote.serviceType || quote.packageOption || 'Unknown'));
            summary.appendChild(svcP);

            const costP = document.createElement('p');
            const costStrong = document.createElement('strong');
            costStrong.textContent = 'Amount: ';
            costP.appendChild(costStrong);
            costP.appendChild(document.createTextNode('$' + (quote.pricing.totalCost || quote.pricing.depositAmount || quote.finalQuoteAmount || 0)));
            summary.appendChild(costP);

            wrapper.appendChild(summary);

            const form = document.createElement('form');
            form.id = 'invoiceForm';

            function addField(labelText, inputId, inputType, value, required) {
                const group = document.createElement('div');
                group.className = 'form-group';
                const label = document.createElement('label');
                label.setAttribute('for', inputId);
                label.textContent = labelText;
                group.appendChild(label);
                if (inputType === 'textarea') {
                    const textarea = document.createElement('textarea');
                    textarea.id = inputId;
                    textarea.name = inputId;
                    textarea.textContent = value;
                    if (required) textarea.required = true;
                    group.appendChild(textarea);
                } else {
                    const input = document.createElement('input');
                    input.type = inputType;
                    input.id = inputId;
                    input.name = inputId;
                    input.value = value;
                    if (required) input.required = true;
                    if (inputType === 'number') input.step = '0.01';
                    group.appendChild(input);
                }
                form.appendChild(group);
            }

            const serviceDesc = (quote.serviceType || quote.packageOption || 'Installation') + ' Service';
            addField('Service Description', 'serviceDescription', 'textarea', serviceDesc, true);
            addField('Amount', 'amount', 'number', quote.pricing.totalCost || quote.finalQuoteAmount || quote.pricing.depositAmount || 0, true);
            addField('Discount (%)', 'invoiceDiscount', 'number', quote.discount || 0, false);

            const dateGroup = document.createElement('div');
            dateGroup.className = 'form-group';
            const dateLabel = document.createElement('label');
            dateLabel.setAttribute('for', 'dueDate');
            dateLabel.textContent = 'Due Date';
            dateGroup.appendChild(dateLabel);
            const dateInput = document.createElement('input');
            dateInput.type = 'date';
            dateInput.id = 'dueDate';
            dateInput.name = 'dueDate';
            const d = new Date();
            d.setDate(d.getDate() + 30);
            dateInput.value = d.toISOString().split('T')[0];
            dateGroup.appendChild(dateInput);
            form.appendChild(dateGroup);

            const actions = document.createElement('div');
            actions.className = 'form-actions';
            const cancelBtn = document.createElement('button');
            cancelBtn.type = 'button';
            cancelBtn.className = 'btn-secondary';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.addEventListener('click', closeInvoiceModal);
            actions.appendChild(cancelBtn);
            const submitBtn = document.createElement('button');
            submitBtn.type = 'submit';
            submitBtn.className = 'btn-primary';
            submitBtn.textContent = 'Create Invoice';
            actions.appendChild(submitBtn);
            form.appendChild(actions);

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                createInvoiceFromQuote(quote._id);
            });

            wrapper.appendChild(form);
            modalBody.appendChild(wrapper);
        }

        async function createInvoiceFromQuote(quoteId) {
            const invoiceData = {
                serviceDescription: document.getElementById('serviceDescription').value,
                amount: parseFloat(document.getElementById('amount').value),
                discount: parseInt(document.getElementById('invoiceDiscount').value) || 0,
                dueDate: document.getElementById('dueDate').value
            };
            try {
                const response = await fetch('/admin/quotes/' + quoteId + '/convert-to-invoice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(invoiceData)
                });
                const result = await response.json();
                if (response.ok && result.success) {
                    alert('Invoice created successfully!');
                    closeInvoiceModal();
                    location.reload();
                } else {
                    alert('Failed to create invoice: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error creating invoice.');
            }
        }

        // Quote editing
        let isEditMode = false;

        const ADDON_PRICING = {
            apMount: 25,
            ethRelocation: 20,
            costPerRun: { cat6: 100, coax: 150, fiber: 200 }
        };

        const CENTRALIZATION_PRICING = {
            'Media Panel': 100,
            'Patch Panel': 50,
            'Loose Termination': 0
        };

        // Quote centralization value from server
        const quoteCentralization = '<%= quote.centralization || "" %>';
        const quoteHasExistingPanel = <%= quote.homeInfo && quote.homeInfo.hasMediaPanel ? 'true' : 'false' %>;

        function setupPricingCalculation() {
            const fields = ['coaxRuns', 'cat6Runs', 'fiberRuns', 'mediaPanel', 'apMount', 'ethRelocation', 'discount'];
            fields.forEach(function(fieldId) {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', calculatePricing);
                    field.addEventListener('change', calculatePricing);
                }
            });
        }

        function calculatePricing() {
            const discount = parseInt(document.getElementById('discount').value) || 0;
            const coax = parseInt(document.getElementById('coaxRuns')?.value) || 0;
            const cat6 = parseInt(document.getElementById('cat6Runs')?.value) || 0;
            const fiber = parseInt(document.getElementById('fiberRuns')?.value) || 0;
            const mp = parseInt(document.getElementById('mediaPanel')?.value) || 0;
            const ap = parseInt(document.getElementById('apMount')?.value) || 0;
            const eth = parseInt(document.getElementById('ethRelocation')?.value) || 0;

            const runsCost = (cat6 * ADDON_PRICING.costPerRun.cat6) +
                             (coax * ADDON_PRICING.costPerRun.coax) +
                             (fiber * ADDON_PRICING.costPerRun.fiber);
            const servicesCost = (ap * ADDON_PRICING.apMount) + (eth * ADDON_PRICING.ethRelocation);

            // Centralization cost (new) or legacy mediaPanel cost
            let centralizationCost = 0;
            if (quoteCentralization) {
                if (quoteCentralization === 'Media Panel') {
                    centralizationCost = quoteHasExistingPanel ? 0 : CENTRALIZATION_PRICING['Media Panel'];
                } else {
                    centralizationCost = CENTRALIZATION_PRICING[quoteCentralization] || 0;
                }
            } else {
                centralizationCost = mp * 100;
            }

            const subtotal = runsCost + servicesCost + centralizationCost;
            const discountAmount = subtotal * (discount / 100);
            const totalCost = Math.max(0, subtotal - discountAmount);
            const depositRequired = totalCost > 100 ? 20 : 0;

            const totalEl = document.getElementById('totalCost');
            const depositEl = document.getElementById('depositRequired');
            if (totalEl) totalEl.textContent = totalCost.toFixed(2);
            if (depositEl) depositEl.textContent = depositRequired.toFixed(2);
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;

            const editableFields = [
                'discount', 'coaxRuns', 'cat6Runs', 'fiberRuns', 'mediaPanel', 'apMount', 'ethRelocation',
                'finalQuoteAmount', 'adminNotes'
            ];

            const toggleBtn = document.getElementById('editToggle');
            const toggleText = document.getElementById('editToggleText');
            const editActions = document.getElementById('editActions');

            if (isEditMode) {
                editableFields.forEach(function(fieldId) {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.readOnly = false;
                        field.style.border = '1px solid rgba(255, 255, 255, 0.3)';
                        field.style.background = '#374151';
                        field.style.padding = '0.5rem';
                        field.style.borderRadius = '0.375rem';
                    }
                });
                if (toggleBtn) { toggleBtn.style.backgroundColor = '#d97706'; toggleBtn.style.color = '#111827'; }
                if (toggleText) toggleText.textContent = 'Cancel Edit';
                if (editActions) editActions.style.display = 'block';
            } else {
                editableFields.forEach(function(fieldId) {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.readOnly = true;
                        field.style.border = 'none';
                        field.style.background = 'transparent';
                        field.style.padding = '0';
                    }
                });
                if (toggleBtn) { toggleBtn.style.backgroundColor = ''; toggleBtn.style.color = ''; }
                if (toggleText) toggleText.textContent = 'Edit Quote';
                if (editActions) editActions.style.display = 'none';
            }
        }

        function cancelEdit() {
            if (confirm('Cancel? All changes will be lost.')) location.reload();
        }

        async function saveQuote() {
            if (!confirm('Save these changes?')) return;

            const quoteData = {
                serviceType: '<%= quote.serviceType || "" %>',
                packageOption: '<%= quote.packageOption || "" %>',
                discount: parseInt(document.getElementById('discount').value) || 0,
                runs: {
                    coax: parseInt(document.getElementById('coaxRuns')?.value) || 0,
                    cat6: parseInt(document.getElementById('cat6Runs')?.value) || 0,
                    fiber: parseInt(document.getElementById('fiberRuns')?.value) || 0
                },
                services: {
                    mediaPanel: parseInt(document.getElementById('mediaPanel')?.value) || 0,
                    apMount: parseInt(document.getElementById('apMount')?.value) || 0,
                    ethRelocation: parseInt(document.getElementById('ethRelocation')?.value) || 0
                },
                adminNotes: document.getElementById('adminNotes').value || ''
            };

            const fqa = document.getElementById('finalQuoteAmount');
            if (fqa && fqa.value) {
                quoteData.finalQuoteAmount = parseFloat(fqa.value);
            }

            try {
                const response = await fetch('/admin/quotes/<%= quote._id %>', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(quoteData)
                });
                const result = await response.json();
                if (response.ok && result.success) {
                    alert('Quote updated successfully!');
                    location.reload();
                } else {
                    alert('Failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error updating quote.');
            }
        }
    </script>
</body>
</html>
